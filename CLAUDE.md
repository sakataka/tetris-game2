# Tetris Game Project

Web上で実行できる美しいテトリスゲーム

## ゲーム概要

- **美しいUI**: モダンなWebデザインとスムーズなアニメーション
- **レスポンシブ**: 1画面に収まる完全なレイアウト
- **多言語対応**: 日本語・英語の言語選択機能

## 主な機能

- 完全なテトリスゲーム体験（移動、回転、ライン消去、スコアリング）
- リアルタイムゲームループ
- キーボード操作（矢印キー、スペース、P）
- 次のピース表示
- レベルアップシステム
- ゲーム一時停止・再開機能
- 言語切り替え（日本語/英語）

## アーキテクチャパターン

### 状態管理

- **Zustand**: 軽量でシンプルな状態管理ライブラリを使用
- 単一のゲームストア（gameStore.ts）でゲーム状態を集中管理
- イミュータブルな状態更新パターン

### コンポーネント設計

- **関数型コンポーネント**: React Hooksを活用したモダンなコンポーネント設計

### ゲームロジック

- **純粋関数**: サイドエフェクトのないゲームロジック
- **テスト駆動開発**: ゲームロジックに包括的なテスト
- **分離された関心事**: ゲームロジック（game/）とUI（components/）の分離

### カスタムHooks

- **useGameLoop**: ゲームの自動進行を管理
- **useKeyboardControls**: react-hotkeys-hookを使用したキーボード入力の宣言的な処理
- **useAnimatedValue**: アニメーション値の管理とスプリングアニメーション制御
- **useAnimationCompletionHandler**: アニメーション完了時の状態管理
- **useCellAnimation**: 個別セルのアニメーション状態管理
- **useGameSelectors**: ゲーム状態の効率的な選択とメモ化

## アニメーションシステム

- **Framer Motion**: 全アニメーション効果のライブラリ
- **ピース落下**: 新しいピースの出現時のスムーズな落下アニメーション
- **ピース回転**: 回転時の360度回転エフェクトとキーベースのアニメーション
- **ピース配置**: 配置時のスケールアニメーション（縮小→拡大）
- **ライン消去**: フラッシュエフェクト（点滅・スケール変化・グロー効果）
- **スコア更新**: スコア、ライン数、レベルの更新時のスプリングアニメーション
- **UI遷移**: ゲームオーバー・一時停止画面のフェードイン/アウト、モーダルのスプリング効果

## メインエントリーポイント

メインエントリーポイントは以下の通りです：

- **index.html**: HTMLエントリーポイント
- **src/main.tsx**: Reactアプリケーションの起点
- **src/App.tsx**: アプリケーションのルートコンポーネント
- **src/components/layout/Game.tsx**: ゲームのメインコンポーネント

## フォルダ構造

```
src/
├── components/          # UIコンポーネント
│   ├── game/           # ゲーム関連UIコンポーネント
│   ├── layout/         # レイアウトコンポーネント
│   └── ui/             # 汎用UIコンポーネント（shadcn/ui）
├── game/               # ゲームロジック（純粋関数）
├── hooks/              # カスタムHooks
├── i18n/               # 国際化設定
├── lib/                # ライブラリユーティリティ
├── locales/            # 言語ファイル
├── store/              # 状態管理（Zustand）
├── test/               # テスト設定
├── types/              # TypeScript型定義
└── utils/              # ユーティリティ関数
    ├── constants.ts    # ゲーム定数（ボードサイズ、速度等）
    ├── styles.ts       # スタイルユーティリティ（CSS結合）
    └── colors.ts       # テトリスピース色定義
```

## データモデル

### 主要な型定義（types/game.ts）

- **GameState**: ゲーム全体の状態（ボード、現在のピース、スコアなど）
- **Tetromino**: テトリスピースの定義（型、位置、回転、形状）
- **Position**: X、Y座標
- **TetrominoType**: 7種類のテトリスピース（I、O、T、S、Z、J、L）

### ゲーム状態

- board: 20×10のゲームボード
- currentPiece: 現在落下中のピース
- nextPiece: 次に出現するピース
- score/lines/level: ゲーム進行状況
- isGameOver/isPaused: ゲーム状態フラグ

## エラーハンドリング

- **TypeScript**: 型安全性による実行時エラーの予防
- **条件チェック**: ゲーム状態の検証（ゲームオーバー、一時停止時の操作無効化）
- **バリデーション**: ピース配置の有効性チェック
- **Graceful Degradation**: 不正な状態でもアプリケーションクラッシュを回避

## 認証

このゲームはクライアントサイドのみで動作するため、認証機能は実装されていません。将来的にハイスコア保存などの機能を追加する際に検討される可能性があります。

## データベース

現在、データベースは使用されていません。ゲーム状態はメモリ内のみで管理され、ページリロード時にリセットされます。

# 開発方針

- **シンプル**: できるだけモダンな機能を利用し、シンプルでメンテナンスしやすく
- **テストファースト**: テスト駆動開発（Bun Test v1.2.17で高速化）
- **技術選択**: 下記以外(利用フレームワーク・ツール)のフレームワーク・ツールが必要になった場合は、確認すること‼️
- **Bun優先**: パッケージ管理、テスト実行、スクリプト実行は基本的にBunを使用
- **Tailwind CSS設定**: Viteプロジェクトでは、PostCSS経由ではなく`@tailwindcss/vite`プラグインを使用する（パフォーマンスと設定の簡素化のため）
- **TODO 駆動開発**: 大がかりな対応をする際は、ドキュメントを作成する。ドキュメントにはフェーズとフェーズ配下のタスクに分けて記載する。フェーズを順番に実行する。1つのフェーズが完了したらドキュメントを更新し、完了したフェーズ・タスクをチェックを入れる。
- **UIリテラルはソースに埋め込まない**: 日本語、英語のリソースファイル対応

## Bun移行成果（2024年12月）

プロジェクトはpnpmから**Bun v1.2.17**への移行を完了し、以下の大幅なパフォーマンス向上を達成しました：

### パフォーマンス向上
- **パッケージインストール**: 85%高速化 (2.64s)
- **テスト実行時間**: 83%高速化 (154ms vs 909ms)
- **開発サーバー起動**: 64%高速化 (263ms vs 731ms)
- **ビルド時間**: 7%改善 (955ms vs 1.03s)

### 移行完了コンポーネント
- **Package Manager**: Bun 1.2.17
- **Test Runner**: Bun test + happy-dom
- **CI/CD**: GitHub Actions、Vercel、Lefthook全てBun対応
- **コアテスト**: ゲームロジック26/26テスト完全通過

### 特記事項
- Vite bundlerは安定性のため継続使用（ハイブリッド構成）
- React Testing Libraryとの型互換性問題は将来のBunアップデートで解決予定
- 移行ドキュメント・チェックリストを`docs/`に完備

## Rolldown-Vite移行成果（2025年6月）

Rust製の高性能バンドラー**Rolldown-Vite v6.3.21**への移行を完了し、ビルド性能で劇的な改善を達成しました：

### パフォーマンス向上
- **ビルド時間**: 82%高速化 (1070ms → 192ms、約5.6倍高速)
- **開発サーバー起動**: 416ms（安定した高速起動）
- **バンドルサイズ**: 最適化により483.10 kB（gzip: 154.75 kB）

### 技術的改善
- **Rust製バンドラー**: JavaScript製バンドラーからの大幅な性能向上
- **統一バンドリング**: 依存関係の事前バンドルと本番ビルドの統一
- **ネイティブプラグイン**: `experimental.enableNativePlugin`で最適化有効

---

## 命名規則・コード品質

### ファイル命名規則
- **コンポーネント**: PascalCase (`Board.tsx`, `Game.tsx`)
- **カスタムフック**: camelCase (`useGameLoop.ts`, `useKeyboardControls.ts`)
- **ユーティリティ・ストア**: camelCase (`gameStore.ts`, `colors.ts`)
- **テスト配置**: `src/*.test.ts` で元ファイルと同じディレクトリに配置

## 積極的改善指針

### パターン認識・品質向上
- **重複パターン**: 類似コードを発見したら抽象化を提案
- **パフォーマンス**: ボトルネックの早期発見・最適化提案
- **アーキテクチャ**: 設計パターンの改善機会を積極的に指摘
- **技術債務**: リファクタリング計画の具体的提案

### 開発効率化・自動化
- **繰り返し作業**: スクリプト化・自動化の提案
- **ボイラープレート**: テンプレート化によるコード生成
- **GitHub Actions**: 共通ワークフローの自動化設定
- **CLI ツール**: プロジェクト固有の効率化ツール作成

### ライブラリ・技術選択
- **より良い選択肢**: 現在の技術スタックに対する改善提案
- **新技術導入**: プロジェクトに適した最新技術の評価・提案
- **依存関係最適化**: 不要な依存の削除・軽量化提案

## モダン技術活用方針

- **React最適化**: React.memoは使用せず、React Compilerの自動最適化に任せる
- **非同期処理**: useTransitionを活用してUIの応答性を維持
- **型安全性**: 判別可能ユニオン型、型ガード、satisfiesを活用した厳密な型定義
- **モダンJS**: ES2024の配列メソッド（Array.from、map/filterチェーン）を積極活用

# 利用フレームワーク・ツール

## フロントエンドフレームワーク

- **React**: 19.1.0
- **@types/react**: 19.1.8
- **@types/react-dom**: 19.1.6

## ビルドツール・開発環境

- **Bun**: 1.2.17 (パッケージマネージャー・テストランナー)
- **Rolldown-Vite**: 6.3.21 (Rust製高性能バンドラー、82%高速化)
- **TypeScript**: 5.8.3 (ES2024ターゲット)
- **Node.js**: 24.2

## スタイリング・UI

- **Tailwind CSS**: 4.1.10
- **@tailwindcss/vite**: 4.1.10 (Vite専用プラグイン - PostCSS設定不要)
- **shadcn/ui**: Radix UIコンポーネント群として実装 (dialog, select, slot等)
- **Framer Motion**: 12.18.1 (アニメーション)
- **class-variance-authority**: 0.7.1 (CVA - コンポーネントバリアント管理)
- **clsx**: 2.1.1, **tailwind-merge**: 3.3.1 (スタイルユーティリティ)
- **lucide-react**: 0.522.0 (アイコン)

## 状態管理・データ処理

- **Zustand**: 5.0.5 (状態管理)

## キーボード入力ハンドリング

- **react-hotkeys-hook**: 5.1.0 (宣言的なキーボード入力管理)

## 国際化

- **i18next**: 25.2.1
- **react-i18next**: 15.5.3 (React統合)

## コード品質・リンティング

- **Biome**: 2.0.4 (リンティング・フォーマッティング)
- **Lefthook**: 1.11.14 (Gitフック管理)

## テスト

- **Bun Test**: v1.2.17 (高速テストランナー)
- **happy-dom**: 18.0.1 (Bun最適化DOMシミュレーション)
- **@testing-library/react**: 16.3.0 (Reactコンポーネントテスト)
- **@testing-library/jest-dom**: 6.6.3 (DOMアサーション拡張)
- **@types/bun**: 1.2.17 (Bun型定義)

## 最適化・バンドル

- **knip**: 5.61.2 (デッドコード検出)
- **Bun最適化**: パッケージインストール、テスト実行で大幅な性能向上

## ソース管理

- **git**: 2.50
- **gh**: 2.74.2

## デプロイメント

- **Vercel**: クラウドホスティング

## CI/CDワークフロー

- **GitHub Actions**: Bun v1.2.17対応済み (oven-sh/setup-bun@v2)
- **Vercel**: Bun対応ビルド設定
- **Lefthook**: Git hooks全てBunコマンドに移行済み

# 現在の実装アーキテクチャ

## アプリケーション構成

### エントリーポイント設計

アプリケーションは、React 19の標準的なエントリーポイント構成に従っています。メインエントリーではReact StrictModeを使用してアプリケーションを初期化し、国際化設定の自動読み込みとグローバルCSSの適用を行っています。アプリケーションのルートコンポーネントは最小限の設計で、メインゲームコンポーネント一つのみを配置するシンプルな構成となっています。

### 型安全な設計

TypeScriptの型システムを活用して、ゲーム全体の型安全性を確保しています。テトリスの7種類のピース型（I、O、T、S、Z、J、L）をユニオン型で定義し、ピースの位置、回転状態、形状を包含する包括的な型システムを構築しています。ゲーム状態は、ボード、現在・次のピース、スコア、レベル、ゲーム状態フラグ、アニメーション用の状態を含む中央集権的な状態管理となっています。

### 状態管理アーキテクチャ

Zustandによる軽量で直感的な状態管理を採用しています。ゲーム操作は純粋関数として実装され、状態更新はImmutableパターンに従って行われます。状態ストアは、ゲーム状態の管理とゲーム操作メソッド（移動、回転、ドロップ、一時停止、リセット）を統合して提供し、アニメーション状態の管理も含んでいます。

### ゲームロジック実装

ゲームロジックは関数型プログラミングの原則に従い、副作用のない純粋関数として実装されています。メインゲームロジックでは、初期状態生成、ピース移動・回転・ドロップ処理、ライン消去、スコア計算などの核となる機能を提供しています。テトリスピースの定義では、7種類のピース形状をデータ構造として管理し、90度時計回り回転アルゴリズムを実装しています。ボード操作では、20×10のゲームボード管理、ピース配置の有効性検証、完成ライン検出・消去機能を提供しています。

### カスタムHooks設計

ゲームループ管理には、requestAnimationFrameを使用したスムーズなフレーム制御を実装し、レベルに応じた落下速度調整、一時停止・ゲームオーバー時の適切な停止処理を行っています。キーボード制御では、react-hotkeys-hookライブラリを活用した宣言的なキー入力管理を採用し、矢印キーによる移動・回転、スペースキーによるハードドロップ、Pキーによる一時停止（デバウンス機能付き）、Enterキーによるゲームリセット機能を提供しています。

### UIコンポーネント構成

メインゲームコンテナでは、カスタムHooksを統合してゲームループとキーボード制御を管理し、CSS Gridによる完全なレスポンシブレイアウトを実装しています。デスクトップ向けのグリッドレイアウトとモバイル向けの縦スタックレイアウトを提供し、各UIコンポーネント（言語選択、スコアボード、ボード、次のピース、操作説明、オーバーレイ）を適切に配置しています。

ゲームボードコンポーネントでは、React.memoによる最適化を実装し、200個のセル（20×10グリッド）を効率的に管理しています。30×30ピクセルの固定サイズセルを採用し、Framer Motionによる豊富なアニメーション効果（ピース落下、配置、ライン消去）を統合しています。

### アニメーションシステム

Framer Motionライブラリを活用した包括的なアニメーション設計を採用しています。新しいピース出現時のスプリングアニメーション、ピース回転時の360度回転エフェクト、ライン消去時のフラッシュ・パルス・グロー効果、スコア更新時のスプリングアニメーション、UI遷移のフェード・モーダル効果など、ゲーム体験を向上させる多様なアニメーションを実装しています。

### 国際化対応

i18nextライブラリによる多言語対応システムを構築しています。デフォルト言語は日本語、フォールバック言語は英語に設定し、ゲーム用語、操作方法、UI文言を含む構造化された言語リソースファイルを管理しています。実行時の言語切り替え機能を提供し、UIリテラルのソースコード埋め込みを完全に排除しています。

### スタイリングシステム

Tailwind CSS 4.1の最新記法を採用し、カスタムテトリス色（各ピース専用色）をテーマシステムで定義しています。shadcn/uiコンポーネントとの統合のためのCSS変数設定、事前生成されるクラスの最適化、全画面固定レイアウトの実装を行っています。モバイルファーストのレスポンシブデザインアプローチを採用し、デバイス別の最適化を図っています。

## 品質保証と最適化

### テスト戦略

Bun Test + TypeScriptによるテスト駆動開発（TDD）アプローチを採用しています。

## 開発コマンド一覧

```bash
# パッケージ管理
bun install                    # 依存関係インストール
bun add <package>              # パッケージ追加
bun remove <package>           # パッケージ削除
bun info <package>             # パッケージ情報表示

# 開発・ビルド
bun run dev                    # 開発サーバー起動
bun run build                  # プロダクションビルド
bun run preview                # ビルド結果プレビュー

# テスト・品質管理
bun test                       # 全テスト実行
bun test --watch               # ウォッチモード
bun test src/game/             # 特定ディレクトリのテスト
bun run lint                   # Biome lint実行
bun run format                 # Biome format実行
bun run typecheck              # TypeScript型チェック
bun run knip                   # デッドコード検出
```

