# テトリスゲーム プロジェクト改善提案

このドキュメントは、プロジェクトのソースコードと設定を分析し、考えられる改善点や潜在的な問題点をまとめたものです。全体として、非常にクリーンでモダンな設計がなされており、ここでの提案は更なる品質向上や将来のメンテナンス性向上を目的としたものです。

## 1. パフォーマンスに関する改善案

### 1.1. `useGameLoop` における `useTransition` の見直し

- **現状:** `src/hooks/useGameLoop.ts` 内で、ゲームの落下処理 (`moveDown`) を React の `startTransition` でラップしています。
- **考察:** `useTransition` は、UIの応答性を維持するために、緊急性の低い状態更新を遅延させる機能です。テトリスのようなリアルタイム性が求められるゲームのコアロジック（ブロックの落下）は、緊急性の高い更新と見なせます。`startTransition` を使うことで、意図しないわずかな遅延が発生し、操作感に影響を与える可能性があります。
- **提案:** `startTransition` の使用を再検討し、`requestAnimationFrame` のコールバックから直接 `moveDown()` アクションを呼び出すことを推奨します。これにより、よりダイレクトで予測可能なゲームループが実現され、スムーズな動作につながります。

```typescript
// 提案: src/hooks/useGameLoop.ts の修正案
// ...
      if (currentTime - lastUpdateTime.current >= gameSpeed) {
        // startTransition を使わずに直接呼び出す
        moveDown();
        lastUpdateTime.current = currentTime;
      }
// ...
```

### 1.2. `Board` コンポーネントのレンダリング最適化

- **現状:** `src/components/game/Board.tsx` は、ボードの各セル (`BoardCell`) に `onAnimationComplete` コールバックを渡しています。
- **考察:** ボードが再レンダリングされるたびに、多数の `onAnimationComplete` 関数インスタンスが生成されています。これはパフォーマンスに大きな影響を与えるものではありませんが、最適化の余地があります。
- **提案:** `useAnimationCompletionHandler` フック内で `handleAnimationComplete` 関数を `useCallback` でメモ化することを検討します。これにより、不要な関数の再生成を防ぎ、`BoardCell` コンポーネントの再レンダリングを抑制できる可能性があります。

## 2. コード構造と設計に関する改善案

### 2.1. `game.ts` の責務分割の深化

- **現状:** `src/game/game.ts` は、ゲームのコアロジックを純粋関数として実装しており、非常にテストしやすい優れた設計です。
- **考察:** `lockCurrentTetromino` 関数は、ピースの固定、ラインクリア、スコア計算、次のピースの生成といった複数の責務を担っており、ゲームロジックの中核として複雑性が高くなっています。
- **提案:**
    - **Piece Bagの管理:** `pieceBag`（次に出現するテトリミノのリスト）に関連する状態とロジックを `src/game/pieceBag.ts` に完全にカプセル化することを推奨します。現在 `game.ts` 内で行われている `pieceBag` の更新処理を `pieceBag.ts` 内の関数として公開し、`game.ts` はそのインターフェースのみを利用するようにリファクタリングします。これにより、関心事がより明確に分離されます。
    - **状態遷移の分割:** `lockCurrentTetromino` の処理を、より小さな責務を持つ関数（例：「ピース固定」「ラインクリアとスコア計算」「次ピース準備」）に分割し、それらを合成する形にすることで、可読性とメンテナンス性がさらに向上します。

### 2.2. Zustand ストアの役割分担

- **現状:** `gameStore.ts` にゲームの主要な状態とアクションが集中しています。
- **考察:** `settingsStore.ts` や `highScoreStore.ts` のようにストアが適切に分離されているのは良い点です。`clearAnimationStates` のような特定のアニメーションに強く関連するアクションは、UIの表示状態を管理するロジックであり、コアなゲーム状態とは少し性質が異なります。
- **提案:** このアクションは `useAnimationCompletionHandler` フックから呼び出されており、現在の実装でも問題はありません。しかし、将来的にアニメーション関連の状態が増える場合は、それらを管理する別のストア（例: `uiStateStore`）に分離することも一考の価値があります。これにより、`gameStore` は純粋なゲームロジックの状態管理に専念できます。

## 3. 冗長性とリファクタリングの機会

### 3.1. 定数の一元管理

- **現状:** `src/utils/constants.ts` で多くの定数が管理されており、これは良い実践です。一方で、`src/utils/styles.ts` のようなファイルにもスタイル関連の定数が存在します。
- **提案:** プロジェクト内で「定数」の置き場所に関するルールをより明確にすることを推奨します。例えば、「UIコンポーネントに密結合したスタイル定義は `styles.ts` に、アプリケーション全体で使われる普遍的な値（ボードのサイズなど）は `constants.ts` に」といったルールを設けることで、一貫性が保たれます。

## 4. 設定ファイル

### 4.1. `tsconfig.json` の `exclude` 設定

- **現状:** `tsconfig.json` でテストファイル (`**/*.test.ts`, `**/*.test.tsx`) が `compilerOptions` の対象から `exclude` されています。
- **考察:** これはビルド時には正しい挙動ですが、開発時にエディタ（VS Codeなど）のTypeScript Language Serverがテストファイル内の型チェックを完全に無視する原因になることがあります。
- **提案:** もしエディタでテストファイル内の型チェックが意図通りに動作していない場合、`tsconfig.json` の `exclude` 配列からテストファイルを削除し、代わりに `include` をより明示的に（例: `["src", "vite.config.ts"]`）設定することを検討してください。ビルドツール（Vite）側ではテストファイルが適切に処理されるため、この変更は開発体験の向上に繋がります。

---

これらの提案が、プロジェクトの品質をさらに高める一助となれば幸いです。

## 修正方針と採用判断

### 1.1. `useGameLoop` における `useTransition` の見直し
**採用: しない**

**理由:**
- React 19のコンパイラーとconcurrent featuresの進化により、`useTransition`の使用は推奨されるパターンとなっています
- 現在の実装では、ゲームの応答性に目立った問題は発生していません
- `useTransition`を削除すると、高負荷時にUIがブロックされる可能性があります
- テトリスのゲームループは1秒間に最大10回程度の更新であり、これは十分に低頻度です

**今後の方針:**
- パフォーマンス問題が実際に発生した場合にのみ再検討します
- React DevToolsのProfilerを使用して、実際のパフォーマンスを計測し、問題がある場合のみ修正を検討します

### 1.2. `Board` コンポーネントのレンダリング最適化
**採用: 既に実装済み**

**理由:**
- `useAnimationCompletionHandler`内で`handleAnimationComplete`は既に`useCallback`でメモ化されています（9行目）
- 提案された最適化は既に実装されているため、追加の修正は不要です

### 2.1. `game.ts` の責務分割の深化
**採用: 部分的に採用**

**理由:**
- `lockCurrentTetromino`は既に`_lockPiece`、`_handleLineClearing`、`_spawnNewPiece`という3つのヘルパー関数に分割されており、良い設計です
- ただし、`pieceBag`の管理について、現在は`createPieceBagManager`を通じて行われているため、より一貫性のあるインターフェースにする余地があります

**実装方針:**
- `pieceBag.ts`に`getNextPieceFromBag`のような高レベルAPIを追加し、bag管理の詳細を完全にカプセル化
- ただし、現在の実装でも十分に機能しており、優先度は低いです

### 2.2. Zustand ストアの役割分担
**採用: しない（現時点では）**

**理由:**
- 現在のアニメーション関連の状態は`gameStore`に密接に関連しており、分離による複雑性の増加が懸念されます
- アニメーション状態（`placedPositions`、`clearingLines`、`animationTriggerKey`）はゲームロジックと密接に連携しています
- 現在の実装はシンプルで理解しやすく、パフォーマンス上の問題もありません

**今後の方針:**
- アニメーション関連の状態が増えて複雑になった場合にのみ、`uiStateStore`への分離を検討します

### 3.1. 定数の一元管理
**採用: する**

**理由:**
- 現在の分離（`constants.ts`と`styles.ts`）は理にかなっていますが、より明確なルールがあることで保守性が向上します
- 新規開発者にとって、どちらのファイルに定数を追加すべきかが明確になります

**実装方針:**
- 各ファイルの冒頭にコメントで以下のルールを明記：
  - `constants.ts`: ゲームロジック、設定値、数値定数
  - `styles.ts`: UIスタイリング、Tailwind CSSクラスの組み合わせ
- 必要に応じて、ファイル間のクロスリファレンスを追加

### 4.1. `tsconfig.json` の `exclude` 設定
**採用: しない**

**理由:**
- 現在の設定（`include: ["src", "vite.config.ts"]`）により、srcディレクトリ内のテストファイルは既に型チェックの対象となっています
- `exclude`はビルド時の最適化として有効であり、開発体験に悪影響は与えていません
- VS Codeなどのエディタは、`include`に含まれるファイルに対して適切に型チェックを行います

**今後の方針:**
- エディタでの型チェックに問題が発生した場合のみ、設定の見直しを検討します

## まとめ

全体的に、このプロジェクトは既に高品質な実装がなされており、提案された改善点の多くは既に対処されているか、現時点では必要性が低いものです。採用する価値があるのは「定数の一元管理ルールの明文化」のみであり、これは小さな改善ですが、長期的な保守性向上に貢献します。
