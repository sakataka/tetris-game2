# リセット機能追加仕様書

## 概要
ゲーム中にいつでもリセットできる機能を追加します。リセットする前に確認ダイアログを表示し、リセット時に現在のスコアをハイスコアとして保存します。

## 機能要件

### 基本機能
- **デスクトップ**: Rキーでリセット確認ダイアログを表示
- **モバイル**: リセットボタンでリセット確認ダイアログを表示
- **確認ダイアログ**: Yes/No選択（デフォルトはNo）
- **スコア保存**: リセット前に現在のスコアをゲームオーバー時と同じ処理でハイスコア判定・保存
- **ゲーム初期化**: 確認後、ゲームを最初の状態にリセット

### 対象状態
- ✅ ゲーム中（プレイ中のみ）
- ❌ ポーズ中（リセット機能無効）
- ❌ ゲームオーバー時（リセット機能無効、現在の不要な機能は削除）

## UI/UX 要件

### 確認ダイアログ
```
┌─────────────────────────────────┐
│          ゲームリセット           │
├─────────────────────────────────┤
│ 現在のゲームをリセットしますか？    │
│ スコアは記録されます。            │
│                                 │
│     [いいえ]    [はい]          │
│      (默认)                     │
└─────────────────────────────────┘
```

### モバイルリセットボタン
- **位置**: ヘッダー右側（設定ボタンの隣）
- **表示条件**: ゲーム中のみ（ポーズ中・ゲームオーバー時は非表示）
- **アイコン**: RefreshCw（回転矢印）
- **スタイル**: オレンジ系の警告色

## 技術仕様

### 実装チェックリスト

#### 1. 状態管理
- [x] gameStoreにresetConfirmationState追加
  - [x] showResetConfirmation: boolean
  - [x] resetGame action を確認ダイアログ対応に修正

#### 2. ダイアログコンポーネント
- [x] ResetConfirmationDialog コンポーネント新規作成
  - [x] 確認メッセージ表示
  - [x] Yes/No ボタン
  - [x] デフォルトフォーカスはNo
  - [x] キーボード操作対応（現時点では不要）

#### 3. キーボードコントロール修正
- [x] useKeyboardControls でRキー動作変更
  - [x] 削除: ゲームオーバー時の不要なRキーリセット機能
  - [x] 追加: ゲーム中（プレイ中のみ）のRキーで確認ダイアログ表示
  - [x] 無効化: ポーズ中・ゲームオーバー時のRキー

#### 4. モバイルUI修正
- [x] MobileHeader にリセットボタン追加
  - [x] ゲーム中のみボタン表示（ポーズ中・ゲームオーバー時は非表示）
  - [x] タップで確認ダイアログ表示

#### 5. ハイスコア保存ロジック
- [x] リセット時のスコア保存処理追加
  - [x] ゲームオーバー時と同じ処理でハイスコア判定・保存
  - [x] useHighScoreSideEffect のロジック活用またはリセット専用処理作成

### 既存機能への影響

#### 変更が必要な箇所
1. **useKeyboardControls.ts**
   - Rキーの動作条件変更
   - 新しいresetConfirm actionの追加

2. **MobileHeader.tsx**
   - リセットボタンの表示条件変更
   - 新しいリセットボタンの追加

3. **gameStore.ts** 
   - resetGame の動作変更
   - 確認ダイアログ状態の追加

#### 影響を受ける可能性のある箇所
- GameOverlay.tsx（既存のゲームオーバー時リセット）
- useHighScoreSideEffect.ts（スコア保存タイミング）

## 確定仕様（要確認事項解決済み）

### 動作仕様 ✅
1. **ポーズ中のリセット**: 無効（リセット機能自体を無効化）
2. **ゲームオーバー時**: 無効（現在の不要なRキー機能は削除）
3. **スコア保存**: ゲームオーバー時と同じ処理（0点なら記録しない等）

### UI/UX仕様 ✅
4. **キーボード操作**: 現時点では不要（将来的に追加可能性あり）
5. **フォーカス管理**: 現時点では不要
6. **連続操作制限**: 不要（確認ダイアログがあるため）

### 国際化 ✅
7. **多言語対応**: 英語/日本語両対応（既存i18nシステム活用）

## 実装優先度

### Phase 1: 基本機能
1. 確認ダイアログコンポーネント作成
2. デスクトップRキー対応
3. モバイルボタン追加
4. ハイスコア保存処理

### Phase 2: 改善・拡張
1. キーボードショートカット対応
2. アニメーション追加
3. 連続操作制限
4. アクセシビリティ改善

## テスト項目

### 機能テスト
- [x] ゲーム中でRキー押下時に確認ダイアログ表示
- [x] ゲーム中でモバイルリセットボタンタップ時に確認ダイアログ表示
- [x] 「はい」選択時にリセット実行
- [x] 「いいえ」選択時にダイアログ閉じてゲーム継続
- [x] リセット時にスコアがゲームオーバー時と同じ処理で保存
- [x] リセット後にゲームが初期状態になる

### エッジケース・無効化テスト
- [x] ポーズ中のRキー・リセットボタンが無効
- [x] ゲームオーバー時のRキーが無効（既存不要機能の削除確認）
- [x] スコア0時のリセット動作（ゲームオーバー時と同じ処理）

### 国際化テスト
- [x] 英語表示でのダイアログ
- [x] 日本語表示でのダイアログ